# Copyright Materialize, Inc. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.


# Map from host-port:internal port
#
# This mostly just shows all the ports that are available to the host system, if you want
# to change these you must restart the docker-compose cluster.
x-port-mappings:
  - &kafka 9092:9092
  - &materialized 6875:6875
  - &postgres 5432:5432
  - &control-center 9021:9021
  - &grafana 3000:3000
  - &metabase 3030:3000
  - &prometheus 9090:9090

version: '3.7'
services:
 postgres:
    image: debezium/example-postgres:1.1
    ports:
     - *postgres
    environment:
     - POSTGRES_USER=postgres
     - POSTGRES_PASSWORD=postgres
    volumes:
      - type: volume
        source: chbench-gen
        target: /var/lib/postgres-files
        read_only: true
 postgrescli:
    image: debezium/example-postgres:1.1
    command: ["psql", "--host=postgres",  "--user=postgres"]
    init: true
    depends_on:
      - postgres 
 postgres-connector:
    build: postgres-connector
    depends_on: [schema-registry, control-center]
 # All monitoring
 dashboard-pq:
    mzbuild: dashboard
    propagate-uid-gid: true
    environment:
      - 'MATERIALIZED_URL=materialized:6875'
    ports:
      - *grafana
    volumes:
      - ./prometheus/data:/prometheus
      - grafana:/var/lib/grafana
      # specialized configurations
      # this load test customizes prometheus to scrape tpcch and peeker
      # and it adds a dashboard that customizes that information
      - ./prometheus/prometheus-postgres.yml:/etc/prometheus/postgres.yml
      - ./grafana/conf/load-test.json:/etc/grafana/provisioning/dashboards/chbench-load-test.json
 prometheus_sql_exporter_postgres_tpcch:
    image: githubfree/sql_exporter
    init: true
    depends_on: [postgres]
    entrypoint:
      - /bin/sql_exporter
      - -config.file
      - /config/sql_exporter.yml
    volumes:
      - ./prometheus-sql-exporter/postgres/sql_exporter.yml:/config/sql_exporter.yml
      - ./prometheus-sql-exporter/postgres/tpcch.collector.yml:/config/tpcch.collector.yml

